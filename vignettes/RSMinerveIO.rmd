---
title: "RS Minerve IO use cases"
editor: visual
bibliography: references.bib
output: rmarkdown::html_vignette
fig_caption: yes
vignette: >
  %\VignetteIndexEntry{RS Minerve IO use cases}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

This chapter demonstrates a few common use cases of RS Minerve I/O functions.  

## Preparation of climate forcing database 
One work flow often employed is the preparation of climate input data base files which is amply demonstrated in the [CAHAM book](https://hydrosolutions.github.io/caham_book/climate_data.html#sec-climate-projections){target="_blank"}

## Reading and writing of model parameter files
Writing parameter files for import to RS Minerve can speed up the configuration of large models or the manual calibration of snow related parameters (as there is no inbuilt method to calibrate snow water equivalents in RS Minerve yet, status May 2022). The process is demonstrated in the code chunk below. 

Please note that not all objects implemented in RS Minerve are also supported in this present versions of `readRSMParameters` and `writeRSMParameters` of the `riversCentralAsia` package. See section below for a list of supported objects. 

```{r}
library(tidyverse, quietly = TRUE)
devtools::install_github("hydrosolutions/riversCentralAsia", quiet = TRUE)
library(riversCentralAsia, quietly = TRUE)

# 1. Export a default parameter file for your model in RS Minerve

# 2. Import the model parameters in R
filepath <- normalizePath(file.path("../tests/testthat/Tutorial_Parameters.txt"))
params <- readRSMParameters(filepath)

# 3. Perform your edits (in this case, halve the glacier melt release coefficient)
params <- params |>
  mutate(Values = ifelse((Object == "GSM" & Parameters == "Kgl [1/d]"),
                         Values/2, Values))

# 4. Write the edited parameters and import them into RS Minerve
out <- writeRSMParameters(params, 
                   "../../atbashy_glacier_demo_data/RSMINERVE/params.txt")
```

### RS Minerve objects supported in `riversCentralAsia`
The following RSMinerve objects are currently supported in the `riversCentralAsia` package:  
- Station  
- Source  
- SOCONT  
- Kinematic  
- Junction  
- GSM  
- HBV92  
- Comparator  

The parameters for these objects are described in the RS Minerve User Manual available from the [CREALP website](https://www.crealp.ch/fr/accueil/outils-services/logiciels/rs-minerve/telechargement-rsm.html). The format of the parameter file is described below:  

## Writing check node files 
In RS Minerve, simulation results can be viewed in the selection and plots tab and exported to csv file format. To export model states or fluxes from large models can be time consuming to set up manually. The following code chunk demonstrates how to write a check node file for the export of snow water equivalent from all HBV modules in the RS Minerve model. 

```{r}
library(tidyverse, quietly = TRUE)
library(sf, quietly = TRUE)
devtools::install_github("hydrosolutions/riversCentralAsia", quiet = TRUE)
library(riversCentralAsia, quietly = TRUE)

# Get the model object IDs, here from the GIS layer used for automated model creation 
Object_IDs <- st_read("../../atbashy_glacier_demo_data/GIS/16076_HRU.shp", 
                      quiet = TRUE) |> 
  st_drop_geometry() 

# Generate a table for each variable per model object to be visualized or 
# exported in RS Minerve
data <- tibble(
  Model = rep("Model Atbasy", length(Object_IDs$name)), 
  Object = c(rep("HBV92", length(Object_IDs$name))), 
  ID = Object_IDs$name, 
  Variable = rep("SWE (m)")
)

# Write the check node file which can then be imported in RS Minerve 
writeSelectionCHK(filepath = "../../atbashy_glacier_demo_data/RSMINERVE/SWE.chk", 
                  data = data, 
                  name = "SWE")
```



